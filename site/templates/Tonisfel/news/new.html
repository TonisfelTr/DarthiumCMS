<form action="../../../scripts/handlers/topicer.php" method="post">
    <include path="news/quizblock.html" root="TEMPLATE_ROOT" once="true"/>
    <hr>
    <input type="hidden" name="topic-id" value="{>*|id}">
    <with var="$topic" value="new \Forum\Models\Topic({>*|id})">
        <div class="topic-open-wrapper col-lg-12 col-md-12 col-xs-12 col-sm-12">
            <div class="topic-open-header">
                {@|$topic->getName()}<br>
                <a href="{>|main-page}">{%|news_board}</a>
                <span>&raquo;</span>
                <a href="{>|category-topics:$topic->getCategoryId()}">{@|$topic->getCategory()->getName()}</a>
            </div>
            <div class="topic-open-header-author row">
                <with var="$author" value="$topic->getAuthor()">
                    <div class="col-lg-6 col-md-6 col-xs-12 col-sm-12">
                        <div class="topic-author-avatar">
                            <img src="{>|user-avatar:$author->getId()}" width="100" height="100">
                        </div>
                        <a href="{>|profile-page:$author->getId()}" class="topic-author-nickname-link">{@|$author->getNickname()}</a>
                        <br>
                        <span class="topic-author-group-span"><a style="color: {@|$author->getUserGroup()->getColor()}" href="{>|group-list:$author->getUserGroup()->getId()}">{@|$author->getUserGroup()->getName()}</a></span>
                        <br>
                        {%|newsviewer.sex}
                        <if condition="$author->getSex() == 3">
                            <span class="glyphicons glyphicons-gender-female"></span> {%|gender_female}
                        </if>
                        <if condition="$author->getSex() == 2">
                            <span class="glyphicons glyphicons-gender-male"></span> {%|gender_male}
                        </if>
                        <if condition="$author->getSex() == 1">
                            <span class="glyphicons glyphicons-gender-intersex"></span> {%|not_setted}
                        </if>
                        <br>
                        {%|last_visit}:
                        <if condition="\Engine\Engine::GetSiteTime() > $author->getLastTime() + 15 * 60">
                            <if condition="$author->getSex() != 3">{%|signed_in_he}</if>
                            <if condition="$author->getSex() == 3">{%|signed_in_she}</if> {%|in} {@|\Engine\Engine::DatetimeFormatToRead(date("Y-m-d H:i:s", $author->getLastTime()))}
                        </if>
                        <if condition="\Engine\Engine::GetSiteTime() <= $author->getLastTime() + 15 * 60">
                            <span style="color: #00dd00;">{%|online}</span><br>
                        </if>
                        <br>
                        <if condition="$author->getSex() == 3">
                            {%|newsviewer.she_registered}
                        </if>
                        <if condition="$author->getSex() != 3">
                            {%|newsviewer.he_registered}
                        </if>
                        {@|\Engine\Engine::DateFormatToRead($author->getRegDate())}
                    </div>
                    <div class="col-lg-6 col-md-6 col-xs-12 col-sm-12">
                        {%|created_topics_count}: {@|\Forum\ForumAgent::GetCountTopicOfAuthor($topic->getAuthorId())}<br>
                        {%|rate}: {@|$author->getReputation()->getReputationPoints()}<br>
                        <if condition="$author->IsSkypePublic()">
                            Skype: <a href="skype:{?@html|$author->getSkype()}?chat">{?@html|$author->getSkype()}</a><br>
                        </if>
                        <if condition="$author->IsEmailPublic()">
                            Email: <a href="mailto:{?@html|$author->getEmail()}">{%|newsviewer.write_to}</a><br>
                        </if>
                        <if condition="$author->IsVKPublic()">
                            VK: <a href="https://vk.com/{?@html|$author->getVK()}">{?@html|$author->getVK()}</a><br>
                        </if>
                    </div>
                </with>
            </div>
            <div class="topic-open-info">
                <div>{%|created_date}: {@|\Engine\Engine::DatetimeFormatToRead($topic->getCreateDate())}</div>
                <div>
                    <if condition="$topic->getLastEditor() != ''">
                        {@|\Engine\LanguageManager::GetTranslation("newsviewer.last_edited")}
                        by <a href="{>|profile-page-defined:$topic->getLastEditor()}">{@|\Users\UserAgent::GetUserNick($topic->getLastEditor())}</a>
                        {%|in} {@|\Engine\Engine::DatetimeFormatToRead($topic->getLastEditDateTime())}
                    </if>
                </div>
            </div>
            <div class="col-lg-12 col-xs-12 col-md-12 col-sm-12" id="topic-author-show-panel">&#9650;</div>
        </div>
        <div class="topic-content">
            {@|Engine\Engine::ChatFilter(\Engine\Engine::CompileMentions(html_entity_decode(\Engine\Engine::CompileBBCode($topic->getText()))))}
        </div>
        <div class="topic-open-footer {@|(($topic->getLikes() > $topic->getDislikes()) ? 'positive' : (($topic->getDislikes() > $topic->getLikes()) ? 'negative' : ''))}">
            <div class="btn-group">
                <if condition="($author === \Users\UserAgent::getCurrentUser() && {p|topic_edit}) || {p|topic_foreign_edit}">
                    <a class="btn btn-default" href="{>|topic-edit:$topic->getId()}">
                        <span class="glyphicons glyphicons-edit"></span>
                    </a>
                </if>
                <if condition="\Users\UserAgent::getCurrentUser() === $author && {p|comment_create}">
                    <a class="btn btn-default" href="#comment-content-textarea">
                        <span class="glyphicons glyphicons-comments"></span>
                        {%|edit}
                    </a>
                </if>
                <if condition="(\Users\UserAgent::getCurrentUser() === $author && {p|topic_delete}) || {p|topic_foreign_delete}">
                    <button class="btn btn-default" type="submit" name="topic-remove-btn">
                        <span class="glyphicons glyphicons-erase"></span> {%|newsviewer.remove_topic}
                    </button>
                </if>
            </div>
            <div class="topic-likes-panel">
                <div id="topic-tolikeit">
                    <span class="glyphicons glyphicons-thumbs-up"></span> <span id="topic-likes-{>*|id}">{@|$topic->getLikes()}</span>
                </div>
                <div class="topic-delimiter">
                    {@|$topic->getMarksCount()}
                </div>
                <div id="topic-todislikeit">
                    <span class="glyphicons glyphicons-thumbs-down"></span> <span id="topic-dislikes-{>*|id}">{@|$topic->getDislikes()}</span>
                </div>
            </div>
        </div>
        <foreach array="\Forum\ForumAgent::GetCommentsOfTopic($topic->getId(), \Engine\RouteAgent::getCurrentRoute()->getName() == 'topic-view' ? 1 : {>*|page})" value="$commentId">
            <with var="$comment" value="new \Forum\Models\TopicComment($commentId)">
                <div class="comment">
                    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12" id="comment-{@|$commentId}">
                        <div class="topic-comment-author">
                            <img class="topic-comment-author-avatar" src="{>|user-avatar:$comment->getAuthorId()}">
                            <a class="comment-author-nickname" href="{>|profile-page:$comment->getAuthorId()}" data-comment-id="{@|$comment->getId()}">{@|$comment->getAuthor()->getNickname()}</a>
                            <span><a href="{>|group-list:$comment->getAuthor()->getUserGroup()->getId()}" style="color: {@|$comment->getAuthor()->getUserGroup()->getColor()}">{@|$comment->getAuthor()->getUserGroup()->getName()}</a></span>
                            Пол: {@|$comment->getAuthor()-getSex()}
                            Рейтинг: {@|$comment->getAuthor()-getSex()}
                            Комментариев: {@|\Forum\ForumAgent::GetCountOfCommentOfUser($comment->getAuthorId())}
                            <a class="pm-href" href=\"profile.php?page=wm&sendTo=">{%|newsviewer.write_upper_case}</a>

                        </div>
                        <form method="post" action="../../../scripts/handlers/topicer.php">
                            <input type="hidden" name="comment-id" value="{@|$comment->getId()}">
                            <div class="comment-block">
                                <div class="topic-comment-wrapper">
                                    <div class="topic-comment-header">
                                        <a class="comment-id-link" href="#comment-{@|$comment->getId()}">#{@|$comment->getId()}</a> |
                                        Создан: {@|\Engine\Engine::DatetimeFormatToRead(date("Y-m-d H:i:s", $comment->getCreateDatetime()))} |
                                    </div>
                                    <div class="topic-comment-body">
                                        <div class="topic-comment-text">
                                            <input type="hidden" data-comment-id="{@|$comment->getId()}" value="{@|$comment->getText()}">
                                            {@|\Engine\Engine::CompileMentions(html_entity_decode(Engine\Engine::ChatFilter(Engine\Engine::CompileBBCode($comment->getText()))))}
                                        </div>
                                        <hr>
                                        <if condition="$author->getSignature() == ''">
                                            {%|not_setted}
                                        </if>
                                        <if condition="$author->getSignature() != ''">
                                            {@|nl2br(html_entity_decode(\Engine\Engine::ChatFilter(\Engine\Engine::CompileBBCode($author->getSignature()))))}
                                        </if>
                                        <hr>
                                    </div>
                                    <div class="topic-comment-footer">
                                        <if condition="$comment->isEdited()">
                                            {@|$comment->getChangeInfoAsText()}
                                        </if>
                                    </div>
                                </div>
                                <div class="topic-comment-btns btn-group">
                                    <if condition="({p|comment_edit} && $comment->getAuthorId() == {!u*?|getId()}) || {p|comment_foreign_edit}">
                                        <a class="btn btn-default btn-comment" href="index.php?topic=">
                                            <span class="glyphicon glyphicon-edit"></span>
                                            {%|edit}
                                        </a>
                                    </if>
                                    <a class="btn btn-default btn-quote" href="#comment-content-textarea" data-comment-id="{@|$comment->getId()}">
                                        <span class="glyphicons glyphicons-quote"></span>
                                        {%|newsviewer.quote}
                                    </a>
                                    <if condition="({p|comment_delete} && $comment->getAuthorId() == {!u*?|getId()}) || {p|comment_foreign_delete}">
                                        <a class="btn btn-default btn-comment" href="index.php?topic=">
                                            <span class="glyphicon glyphicon-edit"></span>
                                            {%|edit}
                                        </a>
                                    </if>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </with>
        </foreach>
        <div class="topic-comment-pagination-block">
            <div class="btn-group topic-comment-pagination">
                <!-- Тут должна быть пагинация -->
            </div>
        </div>
        <hr>
        <h3 class="cover-heading">Оставить комментарий</h3>
        <form action="../../../scripts/handlers/topicer.php" method="post">
            <input type="hidden" name="topic-id" value="{>*|id}">
            <div class="btn-group">
                <button class="btn btn-default" title="Выделить жирным" type="button" onclick="insertBBCode('b', false, document.getElementById('comment-content-textarea'));"><strong>B</strong></button>
                <button class="btn btn-default" title="Курсив" type="button" onclick="insertBBCode('i', false, document.getElementById('comment-content-textarea'));"><em>I</em></button>
                <button class="btn btn-default" title="Подчёркивание" type="button" onclick="insertBBCode('u', false, document.getElementById('comment-content-textarea'));"><ins>U</ins></button>
                <button class="btn btn-default" title="Перечеркнуть" type="button" onclick="insertBBCode('s', false, document.getElementById('comment-content-textarea'));"><s>S</s></button>
            </div>
            <div class="btn-group">
                <button class="btn btn-default" title="Выровнять влево" type="button" onclick="insertBBCode('align=left', 'align', document.getElementById('comment-content-textarea'));"><span class="glyphicon glyphicon-align-left"></span></button>
                <button class="btn btn-default" title="Выровнять по центру" type="button" onclick="insertBBCode('align=center', 'align', document.getElementById('comment-content-textarea'));"><span class="glyphicon glyphicon-align-center"></span></button>
                <button class="btn btn-default" title="Выровнять вправо" type="button" onclick="insertBBCode('align=right', 'align', document.getElementById('comment-content-textarea'));"><span class="glyphicon glyphicon-align-right"></span></button>
            </div>
            <div class="btn-group">
                <select class="btn btn-default" title="Цвет шрифта" id="comment-text-font-filler">
                    <option value="black" style="color: black;">Чёрный</option>
                    <option value="red" style="color: red;">Красный</option>
                    <option value="green" style="color: green;">Зелёный</option>
                    <option value="yellow" style="color: yellow;">Жёлтый</option>
                    <option value="orange" style="color: orange;">Оранжевый</option>
                    <option value="blue" style="color: blue;">Синий</option>
                    <option value="grey" style="color: grey;">Серый</option>
                    <option value="darkgrey" style="color: #545454;">Тёмносерый</option>
                    <option value="white" style="color: white; text-shadow: 1px 1px 1px black;">Белый</option>
                </select>
                <select class="btn btn-default" title="Размер шрифта" id="comment-text-font-sizer">
                    <option value="12">12</option>
                    <option value="14">14</option>
                    <option value="16">16</option>
                    <option value="18">18</option>
                    <option value="20">20</option>
                    <option value="22">22</option>
                </select>
            </div>
            <div class="btn-group">
                <button class="btn btn-default" title="Вставить ролик YouTube" type="button" onclick="insertBBCode('youtube=', true, document.getElementById('comment-content-textarea'));"><span class="glyphicon glyphicon-play btn-youtube"></span></button>
                <button class="btn btn-default" title="Вставить картинку" type="button" onclick="insertBBCode('img=', true, document.getElementById('comment-content-textarea'));"><span class="glyphicon glyphicon-picture"></span></button>
                <button class="btn btn-default" title="Загрузить файл" type="button" onclick="$('#uploader-main').show();"><span class="glyphicon glyphicon-upload"></span> Загрузить файл</button>
            </div>
            <div class="btn-group">
                <button class="btn btn-default" title="Вставить разделитель" type="button" onclick="insertBBCode('hr', true, document.getElementById('comment-content-textarea'));"><span class="glyphicons glyphicons-vector-path-line"></span></button>
                <button class="btn btn-default" title="Спойлер" type="button" onclick="insertBBCode('spoiler', false, document.getElementById('comment-content-textarea'));"><span class="glyphicons glyphicons-note-empty"></span></button>
                <button class="btn btn-default" title="Цитата" type="button" onclick="insertBBCode('quote', 'quote', document.getElementById('comment-content-textarea'));"><span class="glyphicons glyphicons-user-conversation"></span></button>
            </div>
            <textarea class="form-control non-resize" id="comment-content-textarea" name="comment-content-textarea" placeholder="Текст Вашего комментария."></textarea>
            <hr>
            <div class="btn-group">
                <button class="btn btn-default" type="submit" name="topic-add-comment-btn"><span class="glyphicons glyphicons-edit"></span> Оставить комментарий</button>
            </div>
            <hr>
            <div id="newtopic-preview" hidden>

            </div>
        </form>
    </with>
</form>
<script type="text/javascript">
    $("a.btn-quote").on("click", function () {
        var commentId = $(this).attr("data-comment-id");
        var commentText = $("input[data-comment-id=" + commentId + "]").val().trim();
        var quoteAuthor = $("a.comment-author-nickname[data-comment-id=" + commentId + "]").html();

        var quote = "[quote=" + quoteAuthor + "]" + commentText + "[/quote]";

        $("textarea#comment-content-textarea").val($("textarea#comment-content-textarea").val() + quote);
    });

    $("div#topic-author-show-panel").on("click", function () {
        $("div.topic-open-header-author").animate({
            height: "toggle",
            duration: 1000
        }, function () {
            if ($("div.topic-open-header-author").css("display") === "none") {
                $("div#topic-author-show-panel").html("&#9660");
            } else
                $("div#topic-author-show-panel").html("&#9650");
        });

    });

    var UpdateLikePanel = function () {
        $.ajax({
            url: "site/scripts/ajax/estimatortopicajax.php",
            type: "POST",
            data: "topicId={>*|id}&info",
            success: function (data) {
                if (data === "not exists")
                    return;
                data = $.parseJSON(data);
                $("span#topic-likes-{>*|id}").html(data.likes);
                $("div.topic-delimiter").html(data.summa);
                $("span#topic-dislikes-{>*|id}").html(data.dislikes);

                if (data.likes > data.dislikes && !$("div.topic-open-footer").hasClass("positive")) {
                    $("div.topic-open-footer").removeClass("negative");
                    $("div.topic-open-footer").addClass("positive");
                }

                if (data.dislikes > data.likes && !$("div.topic-open-footer").hasClass("negative")) {
                    $("div.topic-open-footer").removeClass("positive");
                    $("div.topic-open-footer").addClass("negative");
                }

                if (data.summa == 0) {
                    $("div.topic-open-footer").removeClass("negative");
                    $("div.topic-open-footer").removeClass("positive");
                }
            }
        });
    };

    //var LikesRefresher = setInterval(UpdateLikePanel, 1000);

    $("div#topic-tolikeit").on("click", function () {
        $.ajax({
            url: "site/scripts/ajax/estimatortopicajax.php",
            type: "POST",
            data: "topicId={>*|id}&mark=1"
        });
    });

    $("div#topic-todislikeit").on("click", function () {
        $.ajax({
            url: "site/scripts/ajax/estimatortopicajax.php",
            type: "POST",
            data: "topicId={>*|id}&mark=0"
        });
    });
</script>
<script type="text/javascript">
    function insertBBCode(openTag, notNeedClose = false, texterElement = null){
        if (texterElement == null)
            var texter = document.getElementById("report-add-message");
        else
            var texter = texterElement;
        startText = texter.value.substring(0, texter.selectionStart);
        endText = texter.value.substring(texter.selectionEnd, texter.value.length);
        tagingText = texter.value.substring(texter.selectionStart, texter.selectionEnd);
        startPos = texter.selectionStart;
        endPos = texter.selectionEnd;
        startText += '[' + openTag + ']';
        if (notNeedClose === false) endText = '[\/' + openTag + ']' + endText;
        if (notNeedClose !== false && notNeedClose !== true) endText = '[\/' + notNeedClose + ']' + endText;
        texter.value = startText + tagingText + endText;
        texter.focus();
        texter.setSelectionRange(startPos + (2 + openTag.length), endPos + (2 + openTag.length));

        //texter.value.insert
    }
    $("button#topic-preview-btn").on("click", function()
    {
        $.ajax({
            url: "/site/scripts/ajax/newtopicpreviewajax.php",
            type: "POST",
            data: "text=" + $("textarea#comment-content-textarea").val(),
            success: function (data) {
                $("div#newtopic-preview").html(data);
                var span = document.createElement("h3");
                $(span).html("Предварительный просмотр");
                $("div#newtopic-preview").prepend(span);
                $("div#newtopic-preview").prepend(document.createElement("hr"));
                $("div#newtopic-preview").show();
                $('html, body').animate({
                    scrollTop: $("div#newtopic-preview").offset().top + 'px'
                }, 'fast');
            }
        });
    });

    $("select#comment-text-font-filler").on("change", function(){
        insertBBCode("color=" + $(this).val(), "color", document.getElementById("comment-content-textarea"));
    });
    $("select#comment-text-font-sizer").on("change", function(){
        insertBBCode("size=" + $(this).val(), "size", document.getElementById("comment-content-textarea"));
    });

    $("div.div-spoiler").on("click", function() {
        var spoiler =  $(this).find("div");
        if ($(spoiler).is(":hidden"))
            $(spoiler).show();
        else
            $(spoiler).hide();
    });
</script>